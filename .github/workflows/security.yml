name: Security Scan

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * 1'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  security-scan:
    name: Weekly Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.4'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Auto update dependencies
      run: |
        echo "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä¾èµ–..."
        go mod tidy
        go get -u all
        go mod verify
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        if [ -n "$(git diff go.mod go.sum)" ]; then
          echo "ğŸ“‹ å‘ç°ä¾èµ–æ›´æ–°ï¼š"
          git diff go.mod go.sum
          echo "HAS_UPDATES=true" >> $GITHUB_ENV
        else
          echo "âœ… ä¾èµ–å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          echo "HAS_UPDATES=false" >> $GITHUB_ENV
        fi

    - name: Install security tools
      run: |
        echo "ğŸ”§ å®‰è£…å®‰å…¨æ‰«æå·¥å…·..."
        go install golang.org/x/vuln/cmd/govulncheck@latest
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest

    - name: Run vulnerability scan
      id: vuln_scan
      run: |
        echo "ğŸ” è¿è¡Œæ¼æ´æ‰«æ..."
        
        # è¿è¡Œgovulncheck
        echo "## Govulncheck Results" > security_report.md
        if govulncheck ./... > govulncheck.txt 2>&1; then
          echo "âœ… Govulncheck: æœªå‘ç°å·²çŸ¥æ¼æ´" >> security_report.md
          echo "VULN_STATUS=clean" >> $GITHUB_ENV
        else
          echo "âŒ Govulncheck: å‘ç°æ½œåœ¨æ¼æ´" >> security_report.md
          echo '```' >> security_report.md
          cat govulncheck.txt >> security_report.md
          echo '```' >> security_report.md
          echo "VULN_STATUS=found" >> $GITHUB_ENV
        fi

    - name: Run security analysis
      id: sec_scan
      run: |
        echo "ğŸ”’ è¿è¡Œå®‰å…¨åˆ†æ..."
        
        # è¿è¡Œgosec
        echo "" >> security_report.md
        echo "## Gosec Results" >> security_report.md
        if gosec -fmt json -out gosec.json ./... 2>/dev/null; then
          # è§£ægosecç»“æœ
          issues=$(jq '.Issues | length' gosec.json 2>/dev/null || echo "0")
          if [ "$issues" -eq 0 ]; then
            echo "âœ… Gosec: æœªå‘ç°å®‰å…¨é—®é¢˜" >> security_report.md
            echo "SEC_STATUS=clean" >> $GITHUB_ENV
          else
            echo "âŒ Gosec: å‘ç° $issues ä¸ªå®‰å…¨é—®é¢˜" >> security_report.md
            echo '```json' >> security_report.md
            jq '.Issues' gosec.json >> security_report.md
            echo '```' >> security_report.md
            echo "SEC_STATUS=issues" >> $GITHUB_ENV
          fi
        else
          echo "âš ï¸ Gosec: æ‰«æå¤±è´¥" >> security_report.md
          echo "SEC_STATUS=error" >> $GITHUB_ENV
        fi

    - name: Check for high-risk vulnerabilities
      id: risk_assessment
      run: |
        echo "âš–ï¸ è¯„ä¼°é£é™©ç­‰çº§..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é«˜å±æ¼æ´
        high_risk=false
        
        if [ "$VULN_STATUS" = "found" ]; then
          # æ£€æŸ¥govulncheckè¾“å‡ºä¸­çš„é«˜å±å…³é”®è¯
          if grep -i "critical\|high\|severe" govulncheck.txt; then
            high_risk=true
          fi
        fi
        
        if [ "$SEC_STATUS" = "issues" ]; then
          # æ£€æŸ¥gosecè¾“å‡ºä¸­çš„é«˜å±é—®é¢˜
          if jq -e '.Issues[] | select(.severity == "HIGH" or .confidence == "HIGH")' gosec.json >/dev/null 2>&1; then
            high_risk=true
          fi
        fi
        
        if [ "$high_risk" = true ]; then
          echo "ğŸš¨ å‘ç°é«˜å±å®‰å…¨é—®é¢˜ï¼" >> security_report.md
          echo "RISK_LEVEL=high" >> $GITHUB_ENV
        else
          echo "âœ… æœªå‘ç°é«˜å±å®‰å…¨é—®é¢˜" >> security_report.md
          echo "RISK_LEVEL=low" >> $GITHUB_ENV
        fi

    - name: Generate security summary
      run: |
        echo "ğŸ“Š ç”Ÿæˆå®‰å…¨æ‘˜è¦..."
        
        # æ·»åŠ æ‘˜è¦åˆ°æŠ¥å‘Š
        echo "" >> security_report.md
        echo "## Security Summary" >> security_report.md
        echo "- **æ‰«ææ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security_report.md
        echo "- **Goç‰ˆæœ¬**: $(go version | cut -d' ' -f3)" >> security_report.md
        echo "- **ä¾èµ–æ›´æ–°**: $HAS_UPDATES" >> security_report.md
        echo "- **æ¼æ´çŠ¶æ€**: $VULN_STATUS" >> security_report.md
        echo "- **å®‰å…¨çŠ¶æ€**: $SEC_STATUS" >> security_report.md
        echo "- **é£é™©ç­‰çº§**: $RISK_LEVEL" >> security_report.md
        
        # æ˜¾ç¤ºå®Œæ•´æŠ¥å‘Š
        echo "ğŸ“‹ å®‰å…¨æ‰«ææŠ¥å‘Šï¼š"
        cat security_report.md

    - name: Create issue for high-risk vulnerabilities
      if: env.RISK_LEVEL == 'high'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security_report.md', 'utf8');
          
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ é«˜å±å®‰å…¨æ¼æ´æ£€æµ‹ - ${new Date().toISOString().split('T')[0]}`,
            body: `## ğŸš¨ å®‰å…¨è­¦æŠ¥
          
          å®šæœŸå®‰å…¨æ‰«æå‘ç°é«˜å±å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ç«‹å³å¤„ç†ï¼
          
          ${report}
          
          ## ğŸ”§ å»ºè®®æ“ä½œ
          
          1. **ç«‹å³å®¡æŸ¥**ï¼šæ£€æŸ¥ä¸Šè¿°å®‰å…¨é—®é¢˜çš„è¯¦ç»†ä¿¡æ¯
          2. **æ›´æ–°ä¾èµ–**ï¼šè¿è¡Œ \`go get -u all\` æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
          3. **ä¿®å¤ä»£ç **ï¼šæ ¹æ®gosecå»ºè®®ä¿®å¤ä»£ç å®‰å…¨é—®é¢˜
          4. **é‡æ–°æµ‹è¯•**ï¼šä¿®å¤åé‡æ–°è¿è¡Œå®‰å…¨æ‰«æ
          5. **å‘å¸ƒè¡¥ä¸**ï¼šå¦‚æœ‰å¿…è¦ï¼Œå‘å¸ƒå®‰å…¨è¡¥ä¸ç‰ˆæœ¬
          
          ## ğŸ“ è”ç³»ä¿¡æ¯
          
          å¦‚éœ€å¸®åŠ©ï¼Œè¯·è”ç³»å®‰å…¨å›¢é˜Ÿæˆ–é¡¹ç›®ç»´æŠ¤è€…ã€‚
          
          ---
          *æ­¤issueç”±è‡ªåŠ¨å®‰å…¨æ‰«æç”Ÿæˆ*`,
            labels: ['security', 'high-priority', 'bug']
          });
          
          console.log(`Created issue #${issue.data.number}`);

    - name: Create PR for dependency updates
      if: env.HAS_UPDATES == 'true' && env.RISK_LEVEL != 'high'
      uses: actions/github-script@v7
      with:
        script: |
          // åˆ›å»ºæ–°åˆ†æ”¯
          const branchName = `security/auto-update-deps-${Date.now()}`;
          
          // è·å–mainåˆ†æ”¯çš„æœ€æ–°commit
          const mainRef = await github.rest.git.getRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'heads/main'
          });
          
          // åˆ›å»ºæ–°åˆ†æ”¯
          await github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: `refs/heads/${branchName}`,
            sha: mainRef.data.object.sha
          });
          
          console.log(`Created branch: ${branchName}`);
          
          // æ³¨æ„ï¼šå®é™…çš„æ–‡ä»¶æ›´æ–°éœ€è¦åœ¨è¿™é‡Œå®ç°
          // è¿™é‡Œåªæ˜¯åˆ›å»ºäº†åˆ†æ”¯ï¼Œå®é™…çš„go.modå’Œgo.sumæ›´æ–°éœ€è¦é¢å¤–çš„æ­¥éª¤

    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          security_report.md
          govulncheck.txt
          gosec.json
        retention-days: 30

    - name: Notify scan completion
      run: |
        echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
        echo "é£é™©ç­‰çº§: $RISK_LEVEL"
        if [ "$RISK_LEVEL" = "high" ]; then
          echo "ğŸš¨ å‘ç°é«˜å±é—®é¢˜ï¼Œå·²åˆ›å»ºissue"
        elif [ "$HAS_UPDATES" = "true" ]; then
          echo "ğŸ“¦ å‘ç°ä¾èµ–æ›´æ–°ï¼Œå»ºè®®æ‰‹åŠ¨å®¡æŸ¥"
        else
          echo "ğŸ‰ ä¸€åˆ‡æ­£å¸¸ï¼Œæ— éœ€æ“ä½œ"
        fi
